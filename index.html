<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Conference Map 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { --font: "Century Gothic", CenturyGothic, AppleGothic, sans-serif; }

    * { box-sizing: border-box; }
    body { margin:0; padding:0; display:flex; flex-direction:column; height:100vh; font-family: var(--font); }

    /* Topbar (shown on mobile) */
    #topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 52px;
      display: none; align-items: center; justify-content: space-between;
      padding: 0 10px; background:#fff; border-bottom:1px solid #e6e6e6; z-index: 1000;
    }
    #topbar .tb-title { font-weight:700; letter-spacing:.2px; }
    #topbar .tb-btn {
      appearance: none; border:1px solid #d6d6d6; background:#fff; padding:6px 10px; border-radius:8px;
      font-size:14px; line-height:1; cursor:pointer; min-width:84px; text-align:center;
      transition: transform .05s ease;
    }
    #topbar .tb-btn:active { transform: translateY(1px); }

    /* Scrim behind drawers (mobile) */
    #scrim { display:none; position: fixed; inset: 52px 0 0 0; background: rgba(0,0,0,.28); z-index: 999; }
    #scrim.show { display:block; }

    /* Desktop layout */
    #main { flex:1; display:flex; min-height:0; }
    #sidebar {
      width: 300px; padding: 12px; background: #f8f8f8; border-right: 1px solid #ddd;
      overflow-y: auto;
    }
    #map { flex:1; height: 100%; background: #D5E8EB; }
    #legend {
      width: 260px; padding: 12px; background: #fafafa; border-left: 1px solid #ddd;
      overflow-y: auto;
    }

    h2 { margin: 8px 0; font-size: 16px; }
    .subs-list label { display:block; margin: 3px 0; font-size: 13px; cursor: pointer; }
    .muted { color:#666; font-size:12px; }

    .legend-title { margin: 8px 0; font-size: 14px; font-weight: 600; }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:13px; margin: 5px 0; }

    .popup-content { line-height: 1.3; font-size: 13px; }
    .popup-content a { word-break: break-all; text-decoration: underline; color: #1f6feb; }
    .leaflet-popup-content,
    .leaflet-popup-content h1,
    .leaflet-popup-content h2,
    .leaflet-popup-content h3,
    .leaflet-popup-content p { font-family: var(--font) !important; }

    /* Popup styling */
    .leaflet-popup-content-wrapper { border-radius: 10px; }
    @media (max-width: 900px) {
      .leaflet-popup-content-wrapper {
        max-height: 60vh;                 /* scroll inside popup if tall */
        overflow: auto;
        max-width: calc(100vw - 48px);    /* never wider than viewport minus side padding */
      }
    }

    /* Custom pin */
    .custom-pin { background: transparent; border: none; }
    .pin-shape {
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--pin-color, #2b7); border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.25), 0 2px 4px rgba(0,0,0,0.35);
      position: relative;
    }
    .pin-shape::after {
      content: "";
      position: absolute;
      left: 50%; transform: translateX(-50%);
      bottom: -8px; width: 0; height: 0;
      border: 8px solid transparent;
      border-top-color: var(--pin-color, #2b7);
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.2));
    }

    /* Legend pin */
    .legend-pin {
      width: 14px; height: 14px; border-radius: 50%;
      background: var(--pin-color, #2b7); border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.25);
      display:inline-block;
    }

    /* Bottom panel (cards) */
    #bottom-panel {
      border-top: 1px solid #ddd;
      background: #fff;
      max-height: 240px;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .conf-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      background: #f9f9f9;
      cursor: pointer;
      flex: 1 1 260px;
      font-size: 13px;
      transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .conf-card:hover { background: #f1f1f1; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .conf-card.selected {
      background: #e9f1ff;
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74,144,226,0.35);
    }
    .conf-title { font-weight: 700; margin-bottom: 4px; display:flex; align-items:center; gap:8px; }
    .conf-meta { color:#444; }
    .card-pin {
      width: 12px; height: 12px; border-radius: 50%;
      background: var(--pin-color, #2b7); border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.25);
      display:inline-block;
      flex: 0 0 auto;
    }
    .group-divider { flex-basis: 100%; height: 0; }

    #clear-btn {
      font-family: var(--font) !important;
      color:#fff; margin-top: 20px; padding: 10px 10px; font-size: 16px;
      border: 1px solid #2B7DA6; border-radius: 6px; background: #2B7DA6; cursor: pointer;
    }
    #clear-btn:hover { background: #1E88BD; border: 1px solid #1E88BD; }

    /* Branding */
    #branding { text-align: center; margin-bottom: 20px; }
    #branding img { width: 250px; display: block; margin: 0 auto 8px; }
    #branding h1 { font-size: 18px; margin: 0; font-weight: 700; }

    /* Map style selector (in Legend) */
    #map-style { margin-top: 20px; font-size: 13px; }
    #map-style label { display: block; margin-bottom: 4px; }

    /* ---------- Mobile drawers ---------- */
    @media (max-width: 900px) {
      #topbar { display:flex; padding-top: env(safe-area-inset-top); height: calc(52px + env(safe-area-inset-top)); }
      #main { margin-top: calc(52px + env(safe-area-inset-top)); }

      #sidebar, #legend {
        position: fixed; top: calc(52px + env(safe-area-inset-top)); bottom: 0;
        width: 88vw; max-width: 420px; background: #fff; z-index: 1001;
        transition: transform .25s ease; box-shadow: 0 8px 24px rgba(0,0,0,.12);
        overflow-y: auto;
      }
      #sidebar { left: 0;  transform: translateX(-100%); border-right: 1px solid #ddd; }
      #legend  { right: 0; transform: translateX(100%);  border-left: 1px solid #ddd; }

      #sidebar.open { transform: translateX(0); }
      #legend.open  { transform: translateX(0); }

      #map { flex: 1 1 auto; }

      #sidebar, #legend { padding: 12px; }
      .subs-list label { margin: 6px 0; }
      #branding img { width: 200px; }
    }
  </style>
</head>
<body>

  <!-- Mobile top bar + scrim -->
  <div id="topbar">
    <button id="btn-filters" class="tb-btn" aria-controls="sidebar" aria-expanded="false">Filters</button>
    <div class="tb-title">Conferences Map</div>
    <button id="btn-legend" class="tb-btn" aria-controls="legend" aria-expanded="false">Legend</button>
  </div>
  <div id="scrim" aria-hidden="true"></div>

  <div id="main">
    <!-- Left: Filters -->
    <div id="sidebar">
      <div id="branding">
        <img src="ABTSx4.png" alt="Logo">
        <h1>Conferences Map</h1>
      </div>

      <h2>Semester I (Jan–Jun)</h2>
      <div id="sem-I" class="subs-list"></div>
      <h2>Semester II (Jul–Dec)</h2>
      <div id="sem-II" class="subs-list"></div>
      <button id="clear-btn">Clear All</button>
      <hr>
      <div class="muted">Tip: tap anywhere on the map to close panels.</div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Right: Legend / Styles -->
    <div id="legend">
      <div class="legend-title">Legend (Subspecialty → Color)</div>
      <div id="legend-items"></div>

      <div id="map-style">
        <div class="legend-title">Map Style</div>
        <label><input type="radio" name="basemap" value="voyager" checked> Carto Voyager</label>
        <label><input type="radio" name="basemap" value="default"> Default OSM</label>
        <label><input type="radio" name="basemap" value="esri"> ESRI World Street</label>
      </div>
    </div>
  </div>

  <div id="bottom-panel"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  (async () => {
    // ======= Load your prepared data =======
    const DATA_URL = "conferences_2026.updated.json";
    const DATA = await fetch(DATA_URL).then(r => r.json());

    // ======= Map setup =======
    const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);
    map.setMaxBounds([[-85, -180], [85, 180]]);

    const baseLayers = {
      default: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }),
      esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ'
      }),
      voyager: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 20
      })
    };
    baseLayers.voyager.addTo(map);
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const val = e.target.value;
        Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
        baseLayers[val].addTo(map);
      });
    });

    // ======= Mobile drawers (filters & legend) with ✕ toggles =======
    const isMobile = () => window.matchMedia('(max-width: 900px)').matches;

    const btnFilters = document.getElementById('btn-filters');
    const btnLegend  = document.getElementById('btn-legend');
    const scrim      = document.getElementById('scrim');
    const sidebarEl  = document.getElementById('sidebar');
    const legendEl   = document.getElementById('legend');
    let openDrawer = null; // 'filters' | 'legend' | null

    function setTopbarUI(){
      btnFilters.textContent = (openDrawer === 'filters') ? '✕' : 'Filters';
      btnLegend.textContent  = (openDrawer === 'legend')  ? '✕' : 'Legend';
      btnFilters.setAttribute('aria-expanded', openDrawer === 'filters');
      btnLegend.setAttribute('aria-expanded',  openDrawer === 'legend');
    }
    function openDrawerFn(which){
      if (!isMobile()) return;
      if (openDrawer === which) { closeDrawers(); return; }
      if (openDrawer === 'filters') sidebarEl.classList.remove('open');
      if (openDrawer === 'legend')  legendEl.classList.remove('open');

      if (which === 'filters') sidebarEl.classList.add('open');
      if (which === 'legend')  legendEl.classList.add('open');

      openDrawer = which;
      scrim.classList.add('show');
      document.body.style.overflow='hidden';
      setTopbarUI();
    }
    function closeDrawers(){
      sidebarEl.classList.remove('open');
      legendEl.classList.remove('open');
      openDrawer = null;
      scrim.classList.remove('show');
      document.body.style.overflow='';
      setTopbarUI();
    }
    btnFilters.addEventListener('click', ()=> openDrawerFn('filters'));
    btnLegend .addEventListener('click', ()=> openDrawerFn('legend'));
    scrim.addEventListener('click', closeDrawers);
    window.addEventListener('resize', ()=> { if (!isMobile()) closeDrawers(); });
    map.on('click', () => { if (isMobile() && openDrawer) closeDrawers(); });
    setTopbarUI();

    // ======= Helpers =======
    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return '';
      return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
    }
    function safeText(v, fallback='') {
      if (v === null || v === undefined) return fallback;
      const s = String(v);
      return (s.toLowerCase() === 'nan') ? fallback : s;
    }
    async function geocode(location) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1&accept-language=en`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const arr = await res.json();
      if (Array.isArray(arr) && arr.length) {
        return { lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon) };
      }
      return { lat:null, lon:null };
    }

    // Popup options with edge padding (prevents clipping on top & sides)
    function popupOpts() {
      const mobile = isMobile();
      const H_PAD = mobile ? 24 : 12;             // left/right padding
      const TOPBAR_PADDING = 90;                  // topbar + a bit of cushion
      const V_TOP  = mobile ? (TOPBAR_PADDING + 12) : 12;
      const V_BR   = 12;
      const maxW = mobile
        ? Math.max(240, Math.min(300, window.innerWidth - (H_PAD * 2) - 12))
        : 320;

      return {
        autoPan: true,
        keepInView: true,
        maxWidth: maxW,
        autoPanPaddingTopLeft: [H_PAD, V_TOP],
        autoPanPaddingBottomRight: [H_PAD, V_BR]
      };
    }

    // ======= Popup content =======
    function popupHTML(it) {
      const shortN = safeText(it.short_name) || 'Conference';
      const full   = safeText(it.full_name);
      const loc    = safeText(it.location_raw) || 'TBA';
      const sd     = formatDate(it.start_date);
      const ed     = formatDate(it.end_date);
      const link   = safeText(it.link);

      return `
        <div class="popup-content">
          <b>${shortN}</b>${full ? ` – ${full}` : ''}<br><br>
          ${loc}<br><br>
          ${sd && ed ? `from ${sd} to ${ed}.<br><br>` : ''}
          ${link ? `<a href="${link}" target="_blank" rel="noopener">Visit website</a>` : ''}
        </div>
      `;
    }

    // ======= Group by semester + subspecialty =======
    const bySemester = { I: new Map(), II: new Map() };
    for (const it of DATA) {
      const sem = it.semester === 'II' ? 'II' : 'I';
      const sub = safeText(it.subspecialty) || 'Unspecified';
      if (!bySemester[sem].has(sub)) bySemester[sem].set(sub, []);
      bySemester[sem].get(sub).push(it);
    }

    // ======= Distinct colors per subspecialty =======
    const SUBS_ALL = Array.from(new Set([
      ...Array.from(bySemester.I.keys()), ...Array.from(bySemester.II.keys())
    ])).sort();

    const BASE_PALETTE = [
      "#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6",
      "#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3",
      "#808000","#ffd8b1","#000075","#808080","#ffe4e1","#40e0d0","#6a3d9a","#b15928",
      "#2b908f","#ff7f0e","#1f77b4","#2ca02c","#d62728","#9467bd"
    ];
    function hslToHex(h, s, l) {
      s/=100; l/=100;
      const c = (1 - Math.abs(2*l - 1)) * s;
      const x = c * (1 - Math.abs((h/60) % 2 - 1));
      const m = l - c/2;
      let [r,g,b] = (h<60)?[c,x,0]: (h<120)?[x,c,0]: (h<180)?[0,c,x]:
                    (h<240)?[0,x,c]: (h<300)?[x,0,c]: [c,0,x];
      const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
    const COLORS = new Map();
    const ICONS  = new Map();
    for (let i=0; i<SUBS_ALL.length; i++) {
      const color = BASE_PALETTE[i] || hslToHex((i* 360/SUBS_ALL.length) % 360, 70, 48);
      COLORS.set(SUBS_ALL[i], color);
    }
    function getIconFor(sub) {
      if (ICONS.has(sub)) return ICONS.get(sub);
      const color = COLORS.get(sub) || '#2b7';
      const icon = L.divIcon({
        className: 'custom-pin',
        html: `<div class="pin-shape" style="--pin-color:${color}"></div>`,
        iconSize: [24, 34],
        iconAnchor: [12, 34],
        popupAnchor: [1, -28]
      });
      ICONS.set(sub, icon);
      return icon;
    }

    // ======= Markers, toggling, and bottom panel =======
    const markerGroups = new Map(); // key: semId__sub -> markers[]
    const visibleMarkers = new Set();
    const openOrder = [];

    // selected state tracking
    let currentSelectedUid = null;

    function buildUid(it) {
      return [
        safeText(it.short_name), safeText(it.start_date),
        safeText(it.location_raw), safeText(it.link)
      ].join('|');
    }

    async function ensureMarker(it, icon, color, key, orderIdx, sub) {
      let lat = (typeof it.lat === 'number') ? it.lat : null;
      let lon = (typeof it.lon === 'number') ? it.lon : null;

      if ((lat == null || lon == null) && (it.location_raw)) {
        const res = await geocode(it.location_raw);
        lat = res.lat; lon = res.lon;
      }
      if (lat == null || lon == null) return null;

      const m = L.marker([lat, lon], { icon }).bindPopup(popupHTML(it), popupOpts());
      m._confData = it;
      m._groupKey = key;
      m._order = orderIdx;
      m._sub = sub;
      m._color = color;
      m._uid = buildUid(it);

      // When marker is clicked → highlight card & scroll to it
      m.on('click', () => {
        currentSelectedUid = m._uid;
        map.panTo(m.getLatLng(), { animate: true });
        updateBottomPanel();
        selectCardByUid(currentSelectedUid, { scroll: true });
        setTimeout(() => selectCardByUid(currentSelectedUid, { scroll: true }), 300);
      });

      // when this marker's popup is closed, clear the card selection if it was selected
      m.on('popupclose', () => {
        if (currentSelectedUid === m._uid) {
          currentSelectedUid = null;
          clearCardSelection();
        }
      });

      return m;
    }

    async function toggleSet(checked, semKey, sub, items) {
      const key = `${semKey}__${sub}`;
      if (!markerGroups.has(key)) markerGroups.set(key, []);
      const arr = markerGroups.get(key);

      if (!checked) {
        for (const m of arr) {
          if (map.hasLayer(m)) map.removeLayer(m);
          visibleMarkers.delete(m);
        }
        const idx = openOrder.indexOf(key);
        if (idx >= 0) openOrder.splice(idx, 1);
        // If the removed group contained the selected item, clear selection
        if (currentSelectedUid && arr.some(mm => mm._uid === currentSelectedUid)) {
          currentSelectedUid = null;
          clearCardSelection();
        }
        updateBottomPanel();
        return;
      }

      if (!openOrder.includes(key)) openOrder.push(key);

      if (arr.length === 0) {
        const icon = getIconFor(sub);
        const color = COLORS.get(sub);
        let i = 0;
        for (const it of items) {
          const m = await ensureMarker(it, icon, color, key, i++, sub);
          if (m) arr.push(m);
        }
      }

      for (const m of arr) { m.addTo(map); visibleMarkers.add(m); }
      updateBottomPanel();
    }

    function cardHTML(it, color) {
      const title = safeText(it.short_name) || 'Conference';
      const loc   = safeText(it.location_raw) || 'TBA';
      const sd    = formatDate(it.start_date);
      const ed    = formatDate(it.end_date);
      return `
        <div class="conf-title">
          <span class="card-pin" style="--pin-color:${color}"></span>
          <span>${title}</span>
        </div>
        <div class="conf-meta">${loc}</div>
        <div class="conf-meta">${sd}${ed ? ' – ' + ed : ''}</div>
      `;
    }

    function clearCardSelection() {
      document.querySelectorAll('.conf-card.selected').forEach(el => el.classList.remove('selected'));
    }

    function selectCardByUid(uid, { scroll=false }={}) {
      if (!uid) return;
      const el = document.querySelector(`.conf-card[data-uid="${CSS.escape(uid)}"]`);
      if (!el) return;
      clearCardSelection();
      el.classList.add('selected');
      if (scroll) el.scrollIntoView({ behavior:'smooth', block:'center', inline:'nearest' });
    }

    // ---- SHOW ALL SELECTED PINS (no viewport filtering) ----
    function updateBottomPanel() {
      const panel = document.getElementById('bottom-panel');
      panel.innerHTML = '';

      // Group every marker that is currently added to the map (i.e., selected via filters)
      const groupMap = new Map();
      visibleMarkers.forEach(m => {
        if (map.hasLayer(m)) {
          if (!groupMap.has(m._groupKey)) groupMap.set(m._groupKey, []);
          groupMap.get(m._groupKey).push(m);
        }
      });

      for (const key of openOrder) {
        const markers = groupMap.get(key);
        if (!markers || markers.length === 0) continue;
        markers.sort((a,b) => a._order - b._order);

        for (const m of markers) {
          const it = m._confData;
          const color = m._color;
          const el = document.createElement('div');
          el.className = 'conf-card';
          el.dataset.uid = m._uid;
          el.innerHTML = cardHTML(it, color);
          if (m._uid === currentSelectedUid) el.classList.add('selected');
          el.addEventListener('click', () => {
            currentSelectedUid = m._uid;
            clearCardSelection();
            el.classList.add('selected');
            m.openPopup();                         // use bound options
            map.panTo(m.getLatLng(), { animate: true }); // no zoom change
            if (isMobile() && openDrawer) closeDrawers();
          });
          panel.appendChild(el);
        }
        const divider = document.createElement('div');
        divider.className = 'group-divider';
        panel.appendChild(divider);
      }
    }

    // ======= Build checkboxes & legend =======
    function buildCheckboxes(semId, semMap) {
      const container = document.getElementById(semId);
      const subs = Array.from(semMap.keys()).sort();
      for (const sub of subs) {
        const id = `${semId}__${sub.replace(/\W+/g,'_')}`;
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.dataset.sub = sub;
        cb.dataset.sem = semId;
        label.appendChild(cb);
        label.append(' ', sub);
        container.appendChild(label);
      }
    }
    function buildLegend() {
      const legend = document.getElementById('legend-items');
      for (const sub of SUBS_ALL) {
        const color = COLORS.get(sub);
        const row = document.createElement('div');
        row.className = 'legend-item';
        row.innerHTML = `<span class="legend-pin" style="--pin-color:${color}"></span><span>${sub}</span>`;
        legend.appendChild(row);
      }
    }

    buildCheckboxes('sem-I', bySemester.I);
    buildCheckboxes('sem-II', bySemester.II);
    buildLegend();

    function wire(semId, semMap) {
      for (const [sub, items] of semMap.entries()) {
        const id = `${semId}__${sub.replace(/\W+/g,'_')}`;
        const cb = document.getElementById(id);
        cb.addEventListener('change', () => {
          toggleSet(cb.checked, semId, sub, items);
        });
      }
    }
    wire('sem-I', bySemester.I);
    wire('sem-II', bySemester.II);

    // (No viewport-based refresh; cards list ALL selected)
    // map.on('moveend', updateBottomPanel);
  })();
  </script>
</body>
</html>
